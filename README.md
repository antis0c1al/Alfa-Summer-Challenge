### Прогнозирование минимального баланса клиентов банка

#### Описание задачи
**Цель**: Предсказать группу минимального баланса клиента на следующий месяц  
**Целевая переменная**: Шкала от 0 (баланс обнулён) до 7 (высокий баланс)  
**Фокус**: Выявление клиентов с риском снижения остатка до минимальных значений  
**Метрика**: **WMAE** (Взвешенная средняя абсолютная ошибка)  

Веса классов при расчёте метрики:

| target | 0    | 1    | 2    | 3    | 4    | 5    | 6    |
|--------|------|------|------|------|------|------|------|
| weight | 1.0  | 0.72 | 0.52 | 0.37 | 0.27 | 0.19 | 0.14 |

---

#### Ключевые этапы решения
**1. Генерация признаков** (0.54):
- Обработка временных меток, категорий, финансовых показателей
- Агрегация данных на уровне клиента
**2. Подбор весов классов** (0.51):
- Использование Optuna для поиска оптимальных весов
- Улучшение WMAE за счет фокуса на критически важные классы
**3. SHAP-анализ** (0.5035):
- Выявление ключевых признаков и удаление маловажных
**4. Тюнинг и ансамблирование** (0.49811):
- Обучение CatBoost и LightGBM с подобранными параметрами
- Усреднение предсказаний моделей
**5. Финальное обучение** (Public: 0.49766, Private: 0.49508):
- Обучение ансамбля на всём датасете без валидации



#### Результаты
| Этап улучшения             | Public Score | Private Score |
|----------------------------|--------------|---------------|
| Базовый CatBoost с сгенерированными признаками          | 0.54         | -             |
| Подбор class_weights       | 0.51         | -             |
| SHAP + отбор признаков     | 0.5035       | -             |
| Тюнинг + ансамблирование  | 0.49811      | 0.49576            |
| **Финальный ансамбль**     | **0.49766**  | **0.49508**   |

---

#### Генерация признаков
Создано 8 групп признаков из транзакционных данных:

##### 1. Базовые финансовые показатели
| Признак                     | Описание |
|-----------------------------|----------|
| `num_transactions`          | Общее количество транзакций |
| `avg_amount`, `min_amount`, `max_amount` | Средняя/мин/макс сумма транзакции |
| `std_amount`, `median_amount` | Стандартное отклонение и медиана суммы |
| `total_amount`              | Общая сумма всех транзакций |
| `q25_amount`, `q75_amount`  | 25-й и 75-й перцентили суммы |
| `transactions_above_<X>`    | Количество транзакций > X руб (X = 500, 1000, ..., 200000) |

##### 2. Временные паттерны
| Признак                          | Описание |
|----------------------------------|----------|
| `weekday_transactions`           | Транзакции в будние дни |
| `weekend_transactions`           | Транзакции в выходные дни |
| `morning_transactions`           | Транзакции утром (6-12) |
| `afternoon_transactions`         | Транзакции днем (12-18) |
| `evening_transactions`           | Транзакции вечером (18-24) |
| `night_transactions`             | Транзакции ночью (0-6) |
| `most_common_hour`               | Самый частый час транзакции |
| `transaction_hour_std`           | Стандартное отклонение часа транзакции |
| `weekend_weekday_ratio`          | Отношение суммы выходных к сумме будних |
| `evening_night_ratio`            | Отношение количества вечерних транзакций к ночным |

##### 3. Активность по месяцам
| Признак               | Описание |
|-----------------------|----------|
| `month_<i>_count`     | Количество транзакций в месяце i (i=1-12) |
| `month_<i>_sum`       | Сумма транзакций в месяце i |
| `month_<i>_ratio`     | Доля транзакций в месяце i |

##### 4. Категориальные признаки
| Признак                          | Описание |
|----------------------------------|----------|
| `unique_mcc`                     | Количество уникальных MCC-кодов |
| `unique_merchants`               | Количество уникальных мерчантов |
| `most_common_mcc`                | Самый частый MCC-код |
| `most_common_mcc_freq`           | Доля транзакций с самым частым MCC-кодом |
| `most_common_merchant`           | Самый частый мерчант |
| `most_common_merchant_freq`      | Доля транзакций с самым частым мерчантом |

##### 5. Поведенческие характеристики
| Признак                       | Описание |
|-------------------------------|----------|
| `min_time_diff_seconds`       | Минимальный интервал между транзакциями (сек) |
| `max_time_diff_seconds`       | Максимальный интервал между транзакциями (сек) |
| `median_time_diff_seconds`    | Медианный интервал между транзакциями (сек) |
| `mean_time_diff_seconds`      | Средний интервал между транзакциями (сек) |
| `recency_days`                | Дней с последней транзакции до даты среза |
| `activity_duration`           | Продолжительность активности (дни) |
| `median_transaction_hour`     | Час медианной транзакции |
| `transaction_frequency`       | Частота транзакций (транзакций/день) |

##### 6. Топ MCC (топ-320)
| Признак               | Описание |
|-----------------------|----------|
| `mcc_<code>_count`    | Количество транзакций для MCC-кода |
| `mcc_<code>_sum`      | Сумма транзакций для MCC-кода |

##### 7. Топ мерчанты (топ-320)
| Признак                  | Описание |
|--------------------------|----------|
| `merch_<merchant>_count` | Количество транзакций для мерчанта |
| `merch_<merchant>_sum`   | Сумма транзакций для мерчанта |

##### 8. Активность в последние периоды
| Признак                             | Описание |
|-------------------------------------|----------|
| `recent_transactions_<T>`           | Количество транзакций за последние T дней (T=1,2,3,5,7,14,21,30) |
| `recent_total_amount_<T>`           | Сумма транзакций за последние T дней |
| `recent_avg_amount_<T>`             | Средняя сумма транзакции за последние T дней |
| `recent_activity_ratio_<T>`         | Доля транзакций за последние T дней |

---

#### Оптимальные веса классов
Подобраны с помощью Optuna для улучшения метрики WMAE:
```python
class_weights = {
    0: 0.7900, 
    1: 0.9220, 
    2: 0.9820, 
    3: 0.6070, 
    4: 0.3870, 
    5: 0.2190, 
    6: 0.1540
}
```
